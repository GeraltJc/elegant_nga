# TDD 工作流（本项目采用）

> 目标：让抓取/解析/增量/入库/搜索/接口这些最容易回归的逻辑有稳定、可回放的验证方式，降低长期维护成本。

## 1. 适用范围

- 后端（Laravel）：抓取器、解析器（UBB→HTML、Sanitizer）、增量判定、入库、API
- 前端（Vue3）：列表/详情/搜索/排序等核心展示与交互逻辑
- 不强制但鼓励：纯文档改动（至少补充“如何验证”的说明）

## 2. 基本原则（Red → Green → Refactor）

1) **先写测试**：明确“期望行为/验收标准”，让测试先失败（Red）  
2) **再写最小实现**：只写让测试通过的最小代码（Green）  
3) **再重构**：消除重复、提升可读性、抽象边界（Refactor），保持测试持续通过

## 3. 测试分层与优先级（建议）

### 3.1 单元测试（最高优先级）

- UBB→HTML：标签解析、引用/折叠/表情、边界输入、非法标签处理
- HTML 白名单清洗：危险 scheme（`javascript:`）、属性白名单、嵌套标签
- 时间口径：Asia/Shanghai 自然日切分、最近 3 天窗口计算
- 增量策略：`last_reply_at` 变化判定、新增楼层游标推进、5 页截断标记、分段补齐、>1000 页跳过

### 3.2 集成/特性测试（覆盖关键链路）

- DB：迁移、唯一约束、upsert 幂等、版本表写入条件
- API：列表分页/排序、搜索（标题 + 1 楼）、详情页聚合
- 抓取任务：对固定 fixtures 回放（不依赖网络），验证入库结果与 run 审计统计

### 3.3 前端测试

- 组件测试：列表/详情渲染、分页/排序切换、空态/错误态
- 业务逻辑测试：搜索条件组合、时间格式化、截断提示展示

> E2E（Playwright/Cypress）可在 MVP 后加入，但不要替代单元与集成测试。

## 4. Fixtures（可回放数据）

- 任何涉及外部依赖（NGA 接口）的测试都应优先使用**本地 fixtures**回放。
- 建议约定 fixtures 目录（落地代码后创建）：
  - 后端：`backend/tests/Fixtures/nga/`
  - 前端：`frontend/src/__fixtures__/`

## 5. 完成定义（Definition of Done, DoD）

每个任务（见 `docs/rules/文件化进度追踪.md`）在标记为 `done` 前必须满足：

- 新增功能：有新增测试覆盖关键行为
- 修复缺陷：有“先失败后通过”的回归测试（能复现、能防回归）
- 测试稳定：不依赖真实网络、不可控时间、随机性
- 关键边界覆盖：空值/异常/截断/重复运行幂等
- 文档同步：引入新约束/新配置/新命令时更新文档或 ADR

## 6. 推荐命令约定（落地脚手架后启用）

- 后端：`backend/` 内以 `php artisan test` 或 `composer test` 作为入口
- 前端：`frontend/` 内以 `npm test`（Vitest）作为入口
- 根目录（可选）：增加统一入口 `make test` / `just test`

## 7. 评审要求（建议用 PR 模板强制）

- PR 必须关联一个 Task：`docs/progress/tasks/T-xxxx-*.md`
- PR 描述写清楚：新增/修改了哪些测试、如何本地验证
