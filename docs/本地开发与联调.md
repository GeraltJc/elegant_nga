# 本地开发与联调

> 说明：本文件与 `README.md` 中对应章节保持同步；更系统的环境约束与流程建议请同时参考 `开发环境设置指南.md`。

## 开发环境（Docker，Mac M2）

环境说明见：`开发环境设置指南.md`

### 1) 启动基础服务（nginx/php/mysql）

```bash
cp .env.example .env
docker compose up -d --build
```

默认访问：

- Nginx：`http://localhost:8080`（可用 `NGINX_PORT` 调整）
- MySQL：`127.0.0.1:3306`（可用 `MYSQL_PORT` 调整）

### 2) 初始化后端（Laravel 12）

```bash
docker compose exec php bash
composer install
cp -n .env.example .env
php artisan key:generate
php artisan migrate
php artisan config:clear
```

说明：后端不再依赖 Node（不包含 backend/package.json/Vite）。Node 仅用于 frontend。

#### HTMLPurifier 缓存刷新（规则变更时）

当你修改 HTML 清洗规则（白名单/自定义属性）时，需要刷新 HTMLPurifier 的定义缓存，完整步骤如下：

1) 更新环境变量（递增版本号）：

```bash
# backend/.env
NGA_HTMLPURIFIER_DEFINITION_REV=2
```

2) 清理或重建配置缓存：

Docker 方式：

```bash
docker compose exec php php artisan config:clear
```

3) 可选：删除 HTMLPurifier 定义缓存文件（确保立即生效）：

Docker 方式：

```bash
docker compose exec php rm -rf storage/framework/cache/htmlpurifier
```

#### ECS 一键部署脚本

```bash
bash scripts/deploy-ecs.sh
```

说明：脚本依赖 `flock`（通常由 util-linux 提供）实现部署互斥锁；缺少时会直接退出。

### 3) 初始化前端（Vue 3 + Vite）

Docker 方式：

```bash
docker compose up -d frontend
```

默认访问：`http://localhost:5173`（可用 `FRONTEND_PORT` 调整）

页面入口：
- 运行报表列表：`http://localhost:5173/crawl-runs`
- 运行报表详情：`http://localhost:5173/crawl-runs/{runId}`

API 说明（运行报表）：
- API 基址（后端）：`http://localhost:8080/api`
- 前端开发代理：`http://localhost:5173/api`（Vite 代理到 nginx）
- 运行列表：`GET /api/crawl-runs?page=1&per_page=20`
- 运行详情：`GET /api/crawl-runs/{runId}`
- 主题明细：`GET /api/crawl-runs/{runId}/threads?only_failed=1`

本地方式：

```bash
cd frontend
npm i
npm run dev
```

### 4) 前端测试（Vitest）

```bash
cd frontend
npm test
```

> Node 版本：`20.19`（见 `.nvmrc`）。

### 5) CI（GitHub Actions）

- 工作流：`.github/workflows/ci.yml`
- 后端：`composer install` → `php artisan migrate` → `php artisan test`（SQLite）
- 前端：`npm ci` → `npm test` → `npm run build`

补充说明（测试环境）：
- `phpunit.xml` 已指定 SQLite + `APP_CONFIG_CACHE` 临时路径，测试不会命中 `bootstrap/cache/config.php`，无需再手动 `config:clear`。

### MySQL 日志（general_log）

为便于定位误操作，已在 `docker/mysql/my.cnf` 开启 general_log（写入 `/var/lib/mysql/general.log`）。

- 注意：general_log 会持续增长，建议在问题排查后关闭或做日志轮转。

