# 缺楼层审计与修补｜脑暴记录

> 目的：记录本次围绕“缺楼层审计与修补”的讨论脉络、核心问题与决策结果，便于后续回看设计背景与取舍。

## 1. 触发背景
- 出现“楼层号最大值与实际 posts 条数不一致”的情况（例如缺 9 楼），但 `is_truncated_by_page_limit=0` / `is_skipped_by_page_total_limit=0`，说明不是页数没抓全，而是中间漏楼层。
- 明确业务一致性：楼层号 0 基连续（0..N），即使源站显示删除/折叠，也要以占位形式落一条 posts。

## 2. 核心问题与澄清
- 楼层号 0 基含义：0 为楼主首帖，最大楼层号为 N，则理论应有 N+1 条记录。
- 为何不只看 `last_reply_at`：只用最后回复时间无法证明“缺楼层”，只能说明主题是否更新。
- `is_truncated_by_page_limit`：表示单次抓取达到页数上限而非末页，若为 0 则认为抓到末页。
- 若主题抓取时已到末页但中间漏层，必须触发“缺楼层复查”。

## 3. 方案选择与取舍
- 方案 A（最终采用）：
  - 新增楼层级审计表 `thread_floor_audit_posts`，并保留 `thread_floor_repair_attempts` 记录单楼层尝试次数。
  - 理由：
    - 楼层级明细更利于定位缺口与修补结果；
    - 尝试次数需要跨运行累计，独立表更稳妥。
- 放弃仅在 `thread_floor_audit_threads` 写 JSON 列表：可读性与查询成本不佳，且与“复查/统计”诉求不匹配。

## 4. 审计规则（批量 + 单主题）
- 批量筛候选（SQL 层）：
  - 条件：
    - `threads.is_truncated_by_page_limit = 0`
    - `threads.is_skipped_by_page_total_limit = 0`
    - `threads.crawl_cursor_max_floor_number IS NOT NULL`
  - 通过 `LEFT JOIN posts` + `GROUP BY threads.id` + `HAVING COUNT(posts.id) < crawl_cursor_max_floor_number + 1` 找到疑似缺口主题。
- 单主题精算缺口：
  - `SELECT floor_number FROM posts WHERE thread_id = ?` 取已存在楼层号集合；
  - 以 `max_floor_number` 为上限遍历 0..N，找缺失楼层。

## 5. 修补策略与限制
- 修补只补缺口楼层，不顺带更新新增楼层（避免“修补脚本 = 另一个抓取任务”）。
- 修补时仅落库 `floor_number <= 修补前最大楼层号` 的数据，避免超量更新。
- 单楼层最多尝试 3 次，超限则标记为 `ignored`，不再尝试。
- 修补抓取页数上限 `--max-post-pages`，且不抓页码 < 1 或超过 `page_total` 的页。

## 6. 数据表设计与字段含义
- `thread_floor_audit_runs`：审计运行汇总（包含失败归因统计 http/parse/db/unknown）。
- `thread_floor_audit_threads`：主题级明细，记录修补前后统计与状态。
- `thread_floor_audit_posts`：楼层级明细，记录每个缺口楼层的修补状态与尝试次数。
- `thread_floor_repair_attempts`：跨运行累计单楼层修补次数。

## 7. 命令与使用方式
- 新增命令：`nga:audit-missing-floors`
- 关键参数：
  - `--repair`：是否修补
  - `--max-post-pages`：修补时单主题最大抓取页数
  - `--limit`：限制审计主题数量
  - `--thread-ids`：指定 tid 列表（逗号分隔）
  - `--source` / `--fixtures`：支持 fixture 回放

## 8. 风险与后续刷新
- 修补流程不更新 threads 的列表口径字段（如 `last_reply_at` / `view_count_display` / `is_pinned` / `is_digest`）。
- 若需要同步列表口径字段，需后续执行 `nga:crawl-lite`。

## 9. 验收要点
- 迁移落库：新增 4 张审计相关表，且字段注释齐全。
- 执行一次审计/修补，确认 `thread_floor_audit_runs/threads/posts` 与 `thread_floor_repair_attempts` 有记录。
- 失败归因统计字段有正确写入。
