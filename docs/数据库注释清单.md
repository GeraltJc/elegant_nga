# 数据库注释清单对照

> 说明：本清单基于迁移里的注释定义整理，便于核对落库结果。
> 来源迁移：
> - `backend/database/migrations/2026_01_20_000006_update_forums_threads_posts_comments.php`
> - `backend/database/migrations/2026_01_20_000007_update_system_table_comments.php`
> - `backend/database/migrations/2026_01_20_000010_create_crawl_runs_table.php`
> - `backend/database/migrations/2026_01_20_000011_create_crawl_run_threads_table.php`
> - `backend/database/migrations/2026_01_30_000001_create_thread_floor_audit_tables.php`
> - `backend/database/migrations/2026_01_30_000002_create_thread_floor_repair_attempts_table.php`
> - `backend/database/migrations/2026_01_30_000003_create_thread_floor_audit_posts_table.php`
> - `backend/database/migrations/2026_01_30_000004_update_thread_floor_audit_threads_table.php`
> - `backend/database/migrations/2026_01_31_000001_add_ignored_floor_count_to_thread_floor_audit_threads_table.php`

## forums（NGA 版块配置与抓取策略（支持多 fid 扩展））

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| source_forum_id | NGA fid |
| forum_name | 版块名称（可选） |
| list_url | 版块列表 URL（排查用） |
| crawl_page_limit | 单次抓取页上限 |
| request_rate_limit_per_sec | 抓取限速（每秒请求数上限） |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## threads（NGA 主题（列表页实体 + 增量判定 + 抓取游标 + 截断信息））

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| forum_id | 所属版块（forums.id） |
| source_thread_id | NGA tid |
| title | 标题原文 |
| title_prefix_text | 标题前缀文本（如 水） |
| author_name | 楼主显示名 |
| author_source_user_id | 楼主 uid（可选） |
| thread_created_at | 发帖时间（列表口径） |
| last_reply_at | 最后回复时间（变化判定） |
| reply_count_display | 列表页显示回复数 |
| view_count_display | 列表页显示浏览数 |
| is_pinned | 是否置顶 |
| is_digest | 是否精华 |
| first_seen_on_list_page_number | 首次发现所在列表页码 |
| last_seen_on_list_page_number | 最近扫描到所在列表页码 |
| is_truncated_by_page_limit | 当前是否仍未抓全（受单次页上限影响） |
| truncated_at_page_number | 本次抓取到的最后页码（绝对页码，用于排查/提示） |
| last_crawled_at | 最近成功抓取时间 |
| last_detected_change_at | 最近一次检测到变化时间 |
| crawl_page_total_last_seen | 最近一次探测到的主题总页数（分段补齐/跳过判定） |
| crawl_backfill_next_page_number | 分段补齐下次起始页码（NULL 表示已补齐） |
| is_skipped_by_page_total_limit | 是否因主题总页数>1000页跳过详情 |
| skipped_by_page_total_limit_at | 首次触发>1000页跳过时间 |
| crawl_cursor_max_floor_number | 已抓到最大楼层号 |
| crawl_cursor_max_source_post_id | 已抓到最大 pid |
| title_last_changed_at | 标题最后变化时间 |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## posts（NGA 楼层（当前版本内容，支持增量追加与删除/折叠标记））

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| thread_id | 所属主题（threads.id） |
| source_post_id | NGA pid |
| floor_number | 楼层号（0 基，0 为首帖） |
| author_name | 楼层作者显示名 |
| author_source_user_id | 楼层作者 uid（可选） |
| post_created_at | 发帖时间 |
| content_html | 楼层内容（当前版本 HTML） |
| content_fingerprint_sha256 | 内容指纹（SHA256） |
| is_deleted_by_source | 是否被源站删除 |
| is_folded_by_source | 是否被源站折叠 |
| content_last_changed_at | 内容最后变化时间 |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## post_revisions（NGA 楼层历史版本（内容变更/删除/折叠的快照审计））

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| post_id | 所属楼层（posts.id） |
| revision_created_at | 我方发现变更时间（抓取时刻） |
| source_edited_at | 来源编辑时间（若可得） |
| content_html | 该版本内容快照 |
| content_fingerprint_sha256 | 该版本指纹（SHA256） |
| change_detected_reason | 变更原因（token 列表，以 ; 分隔：content_fingerprint_changed / marked_deleted_by_source / marked_folded_by_source） |
| crawl_run_thread_id | 抓取明细 ID（crawl_run_threads.id，可空） |

## crawl_runs（抓取运行记录（每次 12 小时任务/手动任务的汇总审计））

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| forum_id | 所属版块（forums.id） |
| run_started_at | 本次运行开始时间 |
| run_finished_at | 本次运行结束时间 |
| run_trigger_text | 触发来源（schedule_12h/manual） |
| date_window_start | 自然日窗口起（上海时区） |
| date_window_end | 自然日窗口止（上海时区） |
| thread_scanned_count | 扫描主题数（窗口过滤后） |
| thread_change_detected_count | last_reply_at 变化判定数 |
| thread_updated_count | 成功完成更新的主题数 |
| http_request_count | HTTP 请求次数（含重试） |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## crawl_run_threads（抓取运行-主题明细（每次 run 对每个主题的处理结果与错误信息））

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| crawl_run_id | 所属运行（crawl_runs.id） |
| thread_id | 所属主题（threads.id） |
| change_detected_by_last_reply_at | 是否因 last_reply_at 变化入队 |
| detected_last_reply_at | 本次检测到的 last_reply_at |
| fetched_page_count | 本次实际抓取页数 |
| page_limit_applied | 是否触发单次页上限 |
| new_post_count | 新增楼层数 |
| updated_post_count | 更新楼层数（编辑/删/折叠） |
| http_error_code | 失败时 HTTP 状态码 |
| error_summary | 错误摘要（固定枚举，可带 msg） |
| started_at | 开始处理该主题的时间 |
| finished_at | 完成处理该主题的时间 |

## thread_floor_audit_runs（主题缺楼层审计运行记录）

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| run_started_at | 审计开始时间 |
| run_finished_at | 审计结束时间（可空） |
| run_trigger_text | 触发来源（manual/cron 等） |
| repair_enabled | 是否包含修补步骤 |
| total_thread_count | 扫描主题数 |
| missing_thread_count | 缺楼层主题数 |
| repaired_thread_count | 修补成功主题数 |
| partial_thread_count | 修补未完全主题数 |
| failed_thread_count | 修补失败主题数 |
| failed_http_count | 修补失败 - HTTP 类统计 |
| failed_parse_count | 修补失败 - 解析类统计 |
| failed_db_count | 修补失败 - 数据库类统计 |
| failed_unknown_count | 修补失败 - 未知类统计 |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## thread_floor_audit_threads（主题缺楼层审计明细与修补结果）

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| audit_run_id | 所属审计运行（thread_floor_audit_runs.id） |
| thread_id | 所属主题（threads.id） |
| source_thread_id | NGA tid |
| max_floor_number | 修补前最大楼层号（0 基） |
| post_count | 修补前楼层条数 |
| missing_floor_count | 缺失楼层数量 |
| ignored_floor_count | 因超次数跳过的楼层数量 |
| repair_status | 修补状态（missing=待修补/repaired=已修补/partial=部分成功/failed=修补失败/skipped=跳过修补） |
| repair_crawl_run_id | 修补触发的 crawl_runs.id（可空） |
| repair_attempted_at | 修补开始时间（可空） |
| repair_finished_at | 修补结束时间（可空） |
| repair_after_max_floor_number | 修补后最大楼层号（0 基，可空） |
| repair_after_post_count | 修补后楼层条数（可空） |
| repair_remaining_floor_count | 修补后仍缺楼层数量（可空） |
| repair_error_summary | 修补失败摘要（可空） |
| repair_error_category | 修补失败归因（http/parse/db/unknown，可空） |
| repair_http_error_code | 修补失败的 HTTP 状态码（可空） |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## thread_floor_audit_posts（缺楼层审计楼层明细（按楼层记录修补结果））

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| audit_run_id | 所属审计运行（thread_floor_audit_runs.id） |
| audit_thread_id | 所属审计主题（thread_floor_audit_threads.id） |
| thread_id | 所属主题（threads.id） |
| source_thread_id | NGA tid |
| floor_number | 缺失楼层号（0 基） |
| repair_status | 修补状态（missing=待修补/ignored=超次数跳过/repaired=修补成功/still_missing=修补后仍缺/failed=修补失败） |
| attempt_count_before | 修补前尝试次数 |
| attempt_count_after | 修补后尝试次数（可空） |
| repair_error_category | 修补失败归因（http/parse/db/unknown，可空） |
| repair_http_error_code | 修补失败的 HTTP 状态码（可空） |
| repair_error_summary | 修补失败摘要（可空） |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## thread_floor_repair_attempts（楼层修补尝试次数记录）

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| thread_id | 所属主题（threads.id） |
| source_thread_id | NGA tid |
| floor_number | 缺失楼层号（0 基） |
| attempt_count | 修补尝试次数（单楼层累计） |
| last_attempted_at | 最近一次尝试时间（可空） |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## users（系统用户表）

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| name | 用户名 |
| email | 邮箱 |
| email_verified_at | 邮箱验证时间 |
| password | 密码哈希 |
| remember_token | 记住我令牌 |
| created_at | 创建时间 |
| updated_at | 更新时间 |

## password_reset_tokens（密码重置令牌）

| 字段 | 中文说明 |
| --- | --- |
| email | 用户邮箱 |
| token | 重置令牌 |
| created_at | 创建时间 |

## sessions（会话表）

| 字段 | 中文说明 |
| --- | --- |
| id | 会话 ID |
| user_id | 用户 ID |
| ip_address | 客户端 IP |
| user_agent | 客户端 UA |
| payload | 会话内容 |
| last_activity | 最近活动时间（时间戳） |

## cache（缓存表）

| 字段 | 中文说明 |
| --- | --- |
| key | 缓存键 |
| value | 缓存值 |
| expiration | 过期时间（时间戳） |

## cache_locks（缓存锁表）

| 字段 | 中文说明 |
| --- | --- |
| key | 锁键 |
| owner | 锁持有者 |
| expiration | 过期时间（时间戳） |

## jobs（队列任务）

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| queue | 队列名称 |
| payload | 任务负载 |
| attempts | 已尝试次数 |
| reserved_at | 预留时间（时间戳） |
| available_at | 可执行时间（时间戳） |
| created_at | 创建时间（时间戳） |

## job_batches（队列批次）

| 字段 | 中文说明 |
| --- | --- |
| id | 批次 ID |
| name | 批次名称 |
| total_jobs | 总任务数 |
| pending_jobs | 待处理任务数 |
| failed_jobs | 失败任务数 |
| failed_job_ids | 失败任务 ID 列表 |
| options | 批次选项 |
| cancelled_at | 取消时间（时间戳） |
| created_at | 创建时间（时间戳） |
| finished_at | 完成时间（时间戳） |

## failed_jobs（失败任务）

| 字段 | 中文说明 |
| --- | --- |
| id | 主键 |
| uuid | 唯一 ID |
| connection | 连接名称 |
| queue | 队列名称 |
| payload | 任务负载 |
| exception | 异常信息 |
| failed_at | 失败时间 |
