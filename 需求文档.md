# 缺楼层审计与修补需求文档

## 1. 背景与问题
- 抓取详情页时，楼层号按 0 基连续（0..N）。即使源站显示删除/折叠，也会落占位楼层。
- 当 `threads.crawl_cursor_max_floor_number = N` 且 `posts` 实际条数 < N+1 时，说明“抓到末页但中间漏楼层”。
- 需要一个离线审计与修补流程，定位缺口并可选择修补，同时避免顺带抓取过多“新增楼层”。

## 2. 目标
- 批量识别“已抓到末页但楼层缺口”的主题。
- 精确到楼层记录缺口与修补结果，支持复查与失败归因统计。
- 修补只补缺口楼层，避免顺带拉新；单楼层修补次数有上限。
- 修补流程可控：限制单主题的最大抓取页数，避免增加过多请求量。

## 3. 方案说明（A）
- 方案 A：新增楼层级审计表 `thread_floor_audit_posts`，并保留 `thread_floor_repair_attempts` 记录单楼层尝试次数。
- 原因：
  - 楼层级明细便于复查与定位；
  - 尝试次数需要跨运行累计，独立表可复用且便于限制重试。

## 4. 审计与修补规则

### 4.1 候选筛选（批量）
满足以下条件的主题进入“疑似缺楼层”候选：
- `threads.is_truncated_by_page_limit = 0`（认为已抓到末页）
- `threads.is_skipped_by_page_total_limit = 0`（不是超大主题跳过）
- `threads.crawl_cursor_max_floor_number IS NOT NULL`（已有最大楼层游标）
- `COUNT(posts.id) < threads.crawl_cursor_max_floor_number + 1`

### 4.2 缺口计算（逐主题）
- 查询该主题所有已存在楼层号：`SELECT floor_number FROM posts WHERE thread_id = ?`
- 以 `max_floor_number` 为上限，遍历 `0..max_floor_number`，找出缺失楼层号。

### 4.3 修补尝试限制
- 单楼层最多尝试 3 次。
- 超过上限的楼层标记为 `ignored`，本次修补跳过，但仍保留明细记录。

### 4.4 修补抓取规则
- 只抓缺口楼层所在的“估算页”，最多抓 `--max-post-pages` 页（默认 5）。
- 不抓页码小于 1 的页；不抓超过 `page_total` 的页。
- 修补时只落库 `floor_number <= 修补前最大楼层号` 的楼层，避免顺带拉新。
- 修补不更新 threads 的列表口径字段（如 `last_reply_at` / `view_count_display` 等）。
  - 若要全量刷新列表字段，需后续执行 `nga:crawl-lite`。

### 4.5 失败归因统计
- 修补失败按 `http/parse/db/unknown` 归因并计数，写入 `thread_floor_audit_runs`。

## 5. 数据落库设计

### 5.1 thread_floor_audit_runs（审计运行汇总）
- 记录一次审计运行的开始/结束、触发来源、是否修补、统计汇总。
- 失败归因统计字段：`failed_http_count/failed_parse_count/failed_db_count/failed_unknown_count`。

### 5.2 thread_floor_audit_threads（主题级明细）
- 记录单主题修补前后统计（最大楼层号、楼层条数、缺口数）。
- `repair_status`：missing/repaired/partial/failed/skipped。
- 失败信息写入 `repair_error_*` 字段。

### 5.3 thread_floor_audit_posts（楼层级明细）
- 记录每个缺失楼层的修补状态与尝试次数。
- `repair_status`：missing/ignored/repaired/still_missing/failed。

### 5.4 thread_floor_repair_attempts（楼层修补尝试次数）
- 以 `(thread_id, floor_number)` 维度累计尝试次数，控制重复修补。

## 6. 命令与参数

### 6.1 命令
`nga:audit-missing-floors`

### 6.2 主要参数
- `--repair`：是否执行修补。
- `--max-post-pages=5`：修补时单主题最多抓取页数。
- `--limit=`：限制审计主题数量（用于小批量测试）。
- `--thread-ids=`：指定 tid 列表（逗号分隔）。
- `--source=http`：数据来源（http/fixture）。
- `--fixtures=`：当 `--source=fixture` 时指定目录（默认 `tests/Fixtures/nga`）。

### 6.3 示例
```bash
# 审计 + 修补指定主题
docker compose exec php php artisan nga:audit-missing-floors --thread-ids=46101568 --repair

# 仅审计，不修补
docker compose exec php php artisan nga:audit-missing-floors --limit=50
```

## 7. 验收与验证
- 运行迁移：`docker compose exec -T php php artisan migrate`。
- 检查表是否存在：`SHOW TABLES LIKE 'thread_floor_%';`。
- 抽查字段注释与状态值是否符合文档定义。
- 运行一次审计并检查：
  - `thread_floor_audit_runs` 有汇总记录；
  - `thread_floor_audit_threads` 有主题明细；
  - `thread_floor_audit_posts` 有楼层明细；
  - `thread_floor_repair_attempts` 累计尝试次数。
- 运行测试：`docker compose exec -T php php artisan test`（SQLite），测试会绕开配置缓存，避免误用 MySQL。
- 前端页面可查看：
  - 审计列表：`/floor-audit-runs`
  - 审计详情：`/floor-audit-runs/{runId}`
  - 楼层明细：`/floor-audit-threads/{auditThreadId}`
- 前端验收清单：`docs/notes/缺楼层审计-前端验收清单.md`（需人工确认）
