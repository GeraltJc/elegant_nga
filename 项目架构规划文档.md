# NGA「艾泽拉斯议事厅」抓取与浏览站点｜项目架构规划

> 目标：抓取 NGA 艾泽拉斯议事厅（fid=7）近 3 天内的新主题（按**发帖时间**口径）及其全楼层内容，长期保存并在个人网页中以列表/分页/搜索/详情页浏览。

## 1. 项目背景与目标

- **数据来源**：NGA 玩家社区「艾泽拉斯议事厅」板块（`thread.php?fid=7`），无需登录。
- **抓取范围**：
  - 主题列表：标题、作者、发帖时间、最后回复时间、回复数、精华/置顶/标签等（能抓到就存）。
  - 主题详情：全楼层（含 1 楼正文 + 回复楼层）。
- **增量更新**：仅抓取**最近 3 天**（按**发帖时间**、按自然日边界）新增主题；对“有变化”的主题仅抓新增楼层。
- **网页功能**：列表 + 分页（30/页）+ 搜索（标题 + 1 楼正文）+ 详情页 + 最近更新时间。

## 2. 关键约束与设计决策

### 2.1 时间口径与时区

- **DB 时区**：`Asia/Shanghai`。
- **最近 3 天边界**：按自然日（例：今天/昨天/前天），以 NGA 显示的发帖时间为准。

### 2.2 抓取入口与解析策略

- 默认走 NGA 的 **`lite=js`** 数据接口（结构化、解析稳定），失败再降级 HTML（可选）。
  - 主题列表：`/thread.php?fid=7&lite=js`（接口说明见 NGA 官方帖子）citeturn0search2turn0search9
  - 论坛大部分功能可通过 `lite=js`/`lite=xml` 输出标准格式数据（接口汇总帖）citeturn0search13
- 内容格式：存储**清洗后的 HTML**（前端直接渲染）。
  - 原始内容可能为 UBB/自定义标签体系，需解析为 HTML；解析器可以自研或复用通用 UBB 解析器并做定制（例如 UBBParser 这类项目）。citeturn0search3
- 图片/附件：**只保存 URL**，不下载文件。

### 2.3 限速与退避

- 默认限速：**≤ 1 req/s**（全局）。
- 退避策略：遇到 429/403/5xx 采用指数退避 + 抖动（jitter），并记录失败原因。

### 2.4 变化判定与增量策略

- “主题有变化”的判定：**last_reply_at 变化**（C4=B）。
- 对有变化主题：只抓新增楼层（C5=A）。
- 单主题抓取阈值：**最多 5 页**（超过则标记为截断）。

### 2.5 编辑/删除处理

- 发现内容变化则更新，并记录历史版本（D7=B）。

### 2.6 项目协作规则（开发流程）

- TDD 工作流：`docs/rules/TDD工作流.md`
- 文件化进度追踪（Task/Log/ADR）：`docs/rules/文件化进度追踪.md`

## 3. 系统架构概览

### 3.1 组件划分

- **Crawler（抓取器）**
  - 列表抓取：扫描近 3 天主题
  - 详情抓取：拉取主题全楼层（首次）/ 新增楼层（增量）
  - 解析与清洗：UBB→HTML、HTML Sanitizer
  - 去重与幂等：基于 thread_id + pid/楼层号
- **Scheduler（调度器）**
  - 每 12 小时触发一次抓取任务
  - 失败重试与告警（本地阶段可仅日志）
- **API（后端服务）**
  - 列表分页、排序切换、搜索
  - 详情页：主题 + 楼层
  - 最近更新时间
- **Web（前端）**
  - Vue3：列表页/详情页/搜索/排序切换

### 3.2 数据流

1) Scheduler 触发抓取
2) Crawler 拉取列表（lite=js）
3) 过滤出“发帖时间在最近 3 天”的主题
4) 对新主题：抓详情全楼层（≤5 页）
5) 对已存在主题：若 last_reply_at 变化 → 抓新增楼层（≤5 页上限内）
6) 解析 → 清洗 → 入库
7) 记录 run_log（运行信息）与 last_updated_at

## 4. 数据模型（概要）

> 详细字段会在「数据库设计」文档中落表；这里先定义实体与关系。

### 4.1 实体与关系

- **threads（主题）** 1 —— N **posts（楼层/回帖）**
- **posts（楼层）** 1 —— N **post_revisions（历史版本，可选但本项目需要）**
- **crawl_runs（抓取运行记录）** 用于追踪每次任务的统计/错误/耗时

### 4.2 主键与去重策略

- 优先使用 **pid**（楼层唯一标识）去重；若拿不到 pid，则退化为 `(thread_id, floor_no)`。
- 主题唯一标识：`thread_id`（tid）。

## 5. 抓取与解析设计

### 5.1 列表抓取

- 请求：`thread.php?fid=7&lite=js`
- 解析：抽取 tid、标题、作者、发帖时间、最后回复时间、回复数、精华/置顶/标签等。
- 过滤：仅保留发帖时间落在“最近 3 天自然日窗口”的主题。

### 5.2 详情抓取（全楼层 / 增量）

- 请求：`read.php?tid={tid}&lite=js`（页码/楼层参数以实际接口为准）
- 首次：从 1 页抓到 min(总页数, 5 页)
- 增量：从“已抓到的最大 pid/楼层号”之后继续抓，直到抓满新增或达到 5 页上限

### 5.3 UBB→HTML 与安全清洗

- 目标：存“可展示”的 HTML，同时避免 XSS。
- 流程：
  1) UBB/标签解析为 HTML
  2) 白名单清洗（仅允许安全标签/属性：`a[href]`, `img[src]`, `br`, `p`, `blockquote`, `code`, `pre`, `strong`, `em`, `ul/ol/li` 等）
  3) 所有链接统一补齐协议、去除 `javascript:` 等危险 scheme

> 说明：NGA 内容可能包含 @、表情、引用、折叠等特性，解析器需要逐步完善；先保证“能看 + 安全”，再追求“完全还原”。

### 5.4 编辑/删除的版本记录

- 当检测到同一 pid 的正文 HTML 发生变化：
  - posts 表更新当前 content_html
  - revisions 表写入旧版本（含变更时间、hash、差异摘要可选）

## 6. Web 产品设计（页面与交互）

### 6.1 列表页

- 默认排序：发帖时间倒序
- 可切换：按最后回复时间倒序
  - 若主题缺 last_reply_at：按你的要求 **排到最后并标记异常**（G10=B）
- 每页：30
- 列表字段：标题、作者、发帖时间、回复数、最后回复时间、精华/置顶/标签、抓取状态（截断/异常）

### 6.2 搜索

- 范围：标题 + 1 楼正文（楼主首帖）
- 实现：MySQL `LIKE`（不引入全文索引）
- 默认搜索范围：全库（长期保留）；可加“仅近3天”筛选（可选）

### 6.3 详情页

- 主题元信息 + 楼层列表（分页/无限滚动二选一，建议分页）
- 楼层显示：楼层号、作者、时间、内容（HTML 渲染）、引用/图片
- 提示：若主题被截断（>5 页），在页面顶部提示“仅抓取前 5 页”。

### 6.4 最近更新时间

- 页面展示：最近一次成功抓取的时间（从 crawl_runs 或 threads.last_crawled_at 汇总）。

## 7. 可靠性与可观测性

- **日志**：抓取开始/结束、请求失败、重试、解析异常、入库异常
- **指标**（可写入 crawl_runs）：抓到主题数、更新主题数、新增楼层数、失败数、耗时
- **幂等**：重复运行不会产生重复数据（unique key + upsert）

## 8. 安全与合规

- 仅个人自用；访问频率受控（≤1 req/s + 退避）。
- 只存 URL，不下载图片/附件。
- 存储内容做 HTML 白名单清洗，防止 XSS。

## 9. 未来上云（阿里云）预留

- Docker 化部署：Nginx + PHP-FPM + MySQL（生产建议 RDS）
- 静态资源与日志：挂载到数据盘
- 计划任务：容器内 cron 或宿主机 cron 触发 `php artisan` 命令

## 10. 里程碑（建议）

1) Lite 接口打通：列表/详情可解析入库
2) 增量策略：last_reply_at 变化 + 只抓新增楼层
3) UBB→HTML + Sanitizer 达到“能看且安全”
4) 前端列表/详情/搜索/排序切换
5) 编辑历史记录
6) 运行报表与稳定性优化
