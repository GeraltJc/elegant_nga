# NGA 艾泽拉斯议事厅（fid=7）抓取站点 — 数据库设计说明（最终版）
> 角色视角：后端架构 + 数据库建模  
> 目标：半年后新人可读、可维护、能支撑“列表 + 分页 + 搜索 + 详情页 + 增量抓取 + 版本记录”。  
> 约束：不为了范式而范式；不使用模糊字段名（如 status/type/flag）；不使用 ext/remark/json 逃避设计；字段语义清晰。

---

## 0. 业务口径摘要（用于理解字段设计）
- 数据源：NGA 论坛 `nga.178.com`，版块 `fid=7`。
- 抓取范围：主题列表 + 主题详情（全楼层）。
- 增量策略：
  - “最近 3 天”口径：按 **主题发帖时间**，且以 **Asia/Shanghai 自然日（00:00~23:59）** 切日。
  - 每 12 小时跑一次。
  - 变化判定：以 **last_reply_at 变化**为准；仅对变化主题进行更新。
  - 更新主题时：**只抓新增楼层**（pid 可得为主锚点）。
  - 单主题抓取页上限：**5 页**；超过则标记截断，后续按分段补齐跨多次抓全。
  - 保护策略：主题总页数 **>1000 页**时，不抓取楼层数据（仅更新 threads 列表字段并记录跳过标记）。
- 缺楼层审计与修补：离线扫描“楼层游标与实际楼层数”不一致的主题，按楼层落表记录缺口；修补只补缺口楼层、单楼层最多尝试 3 次，避免顺带拉新（不更新列表口径字段）。
- 存储：内容存 **清洗后的 HTML**；图片/附件仅存 URL。
- 编辑/删除/折叠：发现变更则更新当前内容，并写入历史版本表（含来源编辑时间）。
- Web 功能：列表（默认按发帖时间倒序，可切换按最后回复时间倒序）+ 分页（30/页）+ 搜索（标题 + 0 楼）+ 详情页 + 最近更新时间。
- 楼层号口径：**0 基**，0 为楼主首帖。

---

## 1. 设计原则（新人必读）
### 1.1 字段分类（用于理解“为什么要存这个字段”）
- **事实字段**：来自 NGA 的客观信息（标题、作者、发帖时间、内容等）。
- **冗余字段**：可推导但为性能/增量检测需要而存（指纹、列表显示回复数等）。
- **状态字段**：系统运行、抓取游标、截断、审计等信息。
- **关联字段**：外键/映射关系。

### 1.2 时间与字符集建议
- 所有 `datetime` 存储都按 **Asia/Shanghai** 语义写入与读取（数据库层或应用层统一设置 `time_zone='+08:00'`）。
- 字符集建议：`utf8mb4`；排序规则建议：`utf8mb4_0900_ai_ci`（MySQL 8 默认较友好）。

### 1.3 命名约定（避免含糊）
- 布尔字段统一 `is_*`（如 `is_truncated_by_page_limit`）。
- “显示值”与“推导值”区分命名（如 `reply_count_display` 表示以列表页显示为准）。
- 不使用 `status/type/flag`；若确需枚举，用 `*_reason`/`*_source` 等明确语义字段。

---

## 2. 核心业务实体拆分（为什么要有这些表）
1. **forums（版块）**：目前只抓 fid=7，但抽象后可扩展多版块；抓取策略配置也有落点。
2. **threads（主题）**：列表页主实体；包含增量判定字段 `last_reply_at`、游标字段、截断标记、页码位置等。
3. **posts（楼层）**：详情页主实体；pid 可得 → 以 `(thread_id, source_post_id)` 做唯一锚点，支持只抓新增。
4. **post_revisions（楼层历史版本）**：满足“编辑/删除/折叠要记录”的可审计需求；主表只存当前版本。
5. **thread_tags + thread_tag_maps（标签）**：统一管理两类标签：话题标签与标题前缀标签（如 `[水]`）。
6. **crawl_runs + crawl_run_threads（抓取运行审计）**：12 小时增量 + 限速退避 + 截断 + 增量游标 → 必须可追溯“某帖为何没更新/为何截断/哪次失败”。
7. **thread_floor_audit_* + thread_floor_repair_attempts（缺楼层审计与修补）**：离线扫描缺口、按楼层记录修补结果，并限制单楼层尝试次数以防重复消耗。

---

## 3. 表清单（含表注释）
> 这里的“表注释”建议直接作为建表 COMMENT 写入数据库，便于 DBA/新人在工具里快速理解。

- `forums`  
  - **表注释**：`NGA 版块配置与抓取策略（支持多 fid 扩展）`
- `threads`  
  - **表注释**：`NGA 主题（列表页实体 + 增量判定 + 抓取游标 + 截断信息）`
- `posts`  
  - **表注释**：`NGA 楼层（当前版本内容，支持增量追加与删除/折叠标记）`
- `post_revisions`  
  - **表注释**：`NGA 楼层历史版本（内容变更/删除/折叠的快照审计）`
- `thread_tags`  
  - **表注释**：`主题标签字典（话题标签/标题前缀标签统一管理）`
- `thread_tag_maps`  
  - **表注释**：`主题与标签关联表（去重 + 记录首次关联时间）`
- `crawl_runs`  
  - **表注释**：`抓取运行记录（每次 12 小时任务/手动任务的汇总审计）`
- `crawl_run_threads`  
  - **表注释**：`抓取运行-主题明细（每次 run 对每个主题的处理结果与错误信息）`
- `thread_floor_audit_runs`  
  - **表注释**：`主题缺楼层审计运行记录`
- `thread_floor_audit_threads`  
  - **表注释**：`主题缺楼层审计明细与修补结果`
- `thread_floor_audit_posts`  
  - **表注释**：`缺楼层审计楼层明细（按楼层记录修补结果）`
- `thread_floor_repair_attempts`  
  - **表注释**：`楼层修补尝试次数记录`

---

## 4. 字段字典（逐表）

### 4.1 `forums`（表注释：NGA 版块配置与抓取策略（支持多 fid 扩展））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| source_forum_id | int unsigned UNIQUE | NGA fid（如 7） | 事实字段 |
| forum_name | varchar(100) NULL | 版块名称（可选） | 事实字段 |
| list_url | varchar(255) | 版块列表 URL（排查用，默认带 `order_by=postdatedesc`） | 事实字段 |
| crawl_page_limit | tinyint unsigned | 单次抓取页上限（5） | 状态字段 |
| request_rate_limit_per_sec | decimal(5,2) | 限速（<=1.00） | 状态字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

**最可能变化字段**：`crawl_page_limit`、`request_rate_limit_per_sec`（抓取策略调整）。

---

### 4.2 `threads`（表注释：NGA 主题（列表页实体 + 增量判定 + 抓取游标 + 截断信息））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| forum_id | bigint unsigned FK | 所属版块（forums.id） | 关联字段 |
| source_thread_id | bigint unsigned | NGA tid | 事实字段 |
| title | varchar(200) | 标题原文 | 事实字段 |
| title_prefix_text | varchar(40) NULL | 标题前缀括号内文本（如 `水`；显示时前端拼成 `[水]`） | 事实字段 |
| author_name | varchar(80) | 楼主显示名 | 事实字段 |
| author_source_user_id | bigint unsigned NULL | 楼主 uid（抓得到就存） | 事实字段 |
| thread_created_at | datetime | 发帖时间（近 3 天口径） | 事实字段 |
| last_reply_at | datetime NULL | 最后回复时间（变化判定字段） | 事实字段 |
| reply_count_display | int unsigned | 列表页显示回复数（以此为准） | 事实字段 |
| view_count_display | int unsigned NULL | 列表页显示浏览数（可选） | 事实字段 |
| is_pinned | tinyint(1) | 是否置顶 | 事实字段 |
| is_digest | tinyint(1) | 是否精华 | 事实字段 |
| first_seen_on_list_page_number | smallint unsigned NULL | 首次发现该主题时位于列表第几页 | 状态字段 |
| last_seen_on_list_page_number | smallint unsigned NULL | 最近一次扫描到时位于列表第几页 | 状态字段 |
| is_truncated_by_page_limit | tinyint(1) | 当前是否仍未抓全（受单次页上限影响） | 状态字段 |
| truncated_at_page_number | tinyint unsigned NULL | 本次抓取到的最后页码（绝对页码，用于排查/提示） | 状态字段 |
| last_crawled_at | datetime NULL | 最近成功抓取时间 | 状态字段 |
| last_detected_change_at | datetime NULL | 最近一次检测到变化的时间 | 状态字段 |
| crawl_page_total_last_seen | int unsigned NULL | 最近一次探测到的主题总页数（用于分段补齐与>1000页跳过判定） | 状态字段 |
| crawl_backfill_next_page_number | int unsigned NULL | 分段补齐的下次起始页码（1-based；NULL表示已补齐到当前已知总页数） | 状态字段 |
| is_skipped_by_page_total_limit | tinyint(1) | 是否因主题总页数>1000页而跳过详情抓取（不抓posts） | 状态字段 |
| skipped_by_page_total_limit_at | datetime NULL | 首次触发“>1000页跳过”的时间（用于审计排查） | 状态字段 |
| crawl_cursor_max_floor_number | int unsigned NULL | 已抓到最大楼层号（0 基增量游标） | 状态字段 |
| crawl_cursor_max_source_post_id | bigint unsigned NULL | 已抓到最大 pid（增量游标） | 状态字段 |
| title_last_changed_at | datetime NULL | 标题最后变化时间（排查/可视化用） | 状态字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

**关键约束（建议写进迁移注释）**
- 唯一：`(forum_id, source_thread_id)`。
- 列表排序索引：`(forum_id, thread_created_at)`、`(forum_id, last_reply_at)`。
- 最近 3 天过滤索引：`(forum_id, thread_created_at)`。
- 标题 LIKE：`(forum_id, title)`。

**最可能变化字段**
- `last_reply_at`：回复变化导致频繁变更（也是变化判定依据）。
- `reply_count_display`：列表展示值随回复增长。
- `last_seen_on_list_page_number`：主题热度变化导致页码位置变化。
- `is_pinned/is_digest`、标签映射：版务操作导致变化。
- `crawl_cursor_*`：增量抓取推进时持续变化。

---

### 4.3 `posts`（表注释：NGA 楼层（当前版本内容，支持增量追加与删除/折叠标记））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| thread_id | bigint unsigned FK | 所属主题（threads.id） | 关联字段 |
| source_post_id | bigint unsigned | NGA pid（主锚点） | 事实字段 |
| floor_number | int unsigned | 楼层号（0 为首帖） | 事实字段 |
| author_name | varchar(80) | 回帖者显示名 | 事实字段 |
| author_source_user_id | bigint unsigned NULL | 回帖者 uid（抓得到就存） | 事实字段 |
| post_created_at | datetime | 楼层发布时间 | 事实字段 |
| content_html | mediumtext | 清洗后的 HTML（当前版本） | 事实字段 |
| content_fingerprint_sha256 | char(64) | 内容指纹（变更检测） | 冗余字段 |
| is_deleted_by_source | tinyint(1) | 来源显示已删除 | 事实字段 |
| is_folded_by_source | tinyint(1) | 来源显示已折叠/隐藏 | 事实字段 |
| content_last_changed_at | datetime NULL | 当前内容最后变化时间 | 状态字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

**关键约束**
- 主唯一：`UNIQUE(thread_id, source_post_id)`。
- 兜底唯一：`UNIQUE(thread_id, floor_number)`（防解析异常重复）。

**最可能变化字段**
- `content_html`：楼层编辑会变化。
- `is_deleted_by_source / is_folded_by_source`：版务删除/折叠会变化。

---

### 4.4 `post_revisions`（表注释：NGA 楼层历史版本（内容变更/删除/折叠的快照审计））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| post_id | bigint unsigned FK | 对应楼层（posts.id） | 关联字段 |
| revision_created_at | datetime | 我方发现变更时间（抓取时刻） | 状态字段 |
| source_edited_at | datetime NULL | 来源提供的编辑时间（若可得） | 事实字段 |
| content_html | mediumtext | 该版本内容快照 | 事实字段 |
| content_fingerprint_sha256 | char(64) | 该版本指纹 | 冗余字段 |
| change_detected_reason | varchar(120) | 变更原因（token 列表，以 ; 分隔） | 状态字段 |
| crawl_run_thread_id | bigint unsigned NULL | 关联抓取明细（crawl_run_threads.id） | 关联字段 |

**change_detected_reason 建议白名单（顺序固定，允许多值用 `;` 拼接）**
- `content_fingerprint_changed`
- `marked_deleted_by_source`
- `marked_folded_by_source`

---

### 4.5 `thread_tags`（表注释：主题标签字典（话题标签/标题前缀标签统一管理））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| tag_text | varchar(50) | 标签文本原样 | 事实字段 |
| tag_source | varchar(20) | `topic_tag` / `title_prefix` | 事实字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

**唯一**：`UNIQUE(tag_source, tag_text)`。

---

### 4.6 `thread_tag_maps`（表注释：主题与标签关联表（去重 + 记录首次关联时间））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| thread_id | bigint unsigned FK | 主题（threads.id） | 关联字段 |
| tag_id | bigint unsigned FK | 标签（thread_tags.id） | 关联字段 |
| first_attached_at | datetime | 首次发现关联时间 | 状态字段 |

**唯一**：`UNIQUE(thread_id, tag_id)`。

---

### 4.7 `crawl_runs`（表注释：抓取运行记录（每次 12 小时任务/手动任务的汇总审计））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| forum_id | bigint unsigned FK | 版块（forums.id） | 关联字段 |
| run_started_at | datetime | 本次运行开始 | 状态字段 |
| run_finished_at | datetime NULL | 本次运行结束 | 状态字段 |
| run_trigger_text | varchar(30) | `schedule_12h` / `manual` | 状态字段 |
| date_window_start | date | 自然日窗口起（上海时区） | 状态字段 |
| date_window_end | date | 自然日窗口止（上海时区） | 状态字段 |
| thread_scanned_count | int unsigned | 扫描主题数 | 状态字段 |
| thread_change_detected_count | int unsigned | last_reply_at 变化判定数 | 状态字段 |
| thread_updated_count | int unsigned | 实际更新成功数 | 状态字段 |
| http_request_count | int unsigned | 请求数（排查限速/退避用） | 状态字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

---

### 4.8 `crawl_run_threads`（表注释：抓取运行-主题明细（每次 run 对每个主题的处理结果与错误信息））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| crawl_run_id | bigint unsigned FK | 所属 run（crawl_runs.id） | 关联字段 |
| thread_id | bigint unsigned FK | 主题（threads.id） | 关联字段 |
| change_detected_by_last_reply_at | tinyint(1) | 是否因 last_reply_at 变化入队 | 状态字段 |
| detected_last_reply_at | datetime NULL | 本次检测到的 last_reply_at | 事实字段 |
| fetched_page_count | tinyint unsigned | 实抓页数（<=5） | 状态字段 |
| page_limit_applied | tinyint(1) | 是否触发页上限 | 状态字段 |
| new_post_count | int unsigned | 新增楼层数 | 状态字段 |
| updated_post_count | int unsigned | 更新楼层数（编辑/删/折叠） | 状态字段 |
| http_error_code | int unsigned NULL | 失败时 HTTP code | 状态字段 |
| error_summary | varchar(200) NULL | 明确错误摘要（不使用 remark/ext） | 状态字段 |
| started_at | datetime | 开始处理该主题 | 状态字段 |
| finished_at | datetime NULL | 完成处理该主题 | 状态字段 |

---

### 4.9 `thread_floor_audit_runs`（表注释：主题缺楼层审计运行记录）
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| run_started_at | datetime | 审计开始时间 | 状态字段 |
| run_finished_at | datetime NULL | 审计结束时间 | 状态字段 |
| run_trigger_text | varchar(30) | 触发来源（manual/cron） | 状态字段 |
| repair_enabled | tinyint(1) | 是否包含修补步骤 | 状态字段 |
| total_thread_count | int unsigned | 扫描主题数 | 状态字段 |
| missing_thread_count | int unsigned | 缺楼层主题数 | 状态字段 |
| repaired_thread_count | int unsigned | 修补成功主题数 | 状态字段 |
| partial_thread_count | int unsigned | 修补未完全主题数 | 状态字段 |
| failed_thread_count | int unsigned | 修补失败主题数 | 状态字段 |
| failed_http_count | int unsigned | 修补失败（HTTP 类）统计 | 状态字段 |
| failed_parse_count | int unsigned | 修补失败（解析类）统计 | 状态字段 |
| failed_db_count | int unsigned | 修补失败（数据库类）统计 | 状态字段 |
| failed_unknown_count | int unsigned | 修补失败（未知类）统计 | 状态字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

---

### 4.10 `thread_floor_audit_threads`（表注释：主题缺楼层审计明细与修补结果）
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| audit_run_id | bigint unsigned FK | 所属审计运行（thread_floor_audit_runs.id） | 关联字段 |
| thread_id | bigint unsigned FK | 所属主题（threads.id） | 关联字段 |
| source_thread_id | bigint unsigned | NGA tid | 事实字段 |
| max_floor_number | int unsigned | 修补前最大楼层号（0 基） | 状态字段 |
| post_count | int unsigned | 修补前楼层条数 | 状态字段 |
| missing_floor_count | int unsigned | 缺失楼层数量 | 状态字段 |
| ignored_floor_count | int unsigned | 因超次数跳过的楼层数量 | 状态字段 |
| repair_status | varchar(20) | 修补状态（missing/repaired/partial/failed/skipped） | 状态字段 |
| repair_crawl_run_id | bigint unsigned NULL | 修补触发的 crawl_runs.id | 关联字段 |
| repair_attempted_at | datetime NULL | 修补开始时间 | 状态字段 |
| repair_finished_at | datetime NULL | 修补结束时间 | 状态字段 |
| repair_after_max_floor_number | int unsigned NULL | 修补后最大楼层号（0 基） | 状态字段 |
| repair_after_post_count | int unsigned NULL | 修补后楼层条数 | 状态字段 |
| repair_remaining_floor_count | int unsigned NULL | 修补后仍缺楼层数量 | 状态字段 |
| repair_error_summary | varchar(200) NULL | 修补失败摘要 | 状态字段 |
| repair_error_category | varchar(20) NULL | 修补失败归因（http/parse/db/unknown） | 状态字段 |
| repair_http_error_code | smallint unsigned NULL | 修补失败的 HTTP 状态码 | 状态字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

---

### 4.11 `thread_floor_audit_posts`（表注释：缺楼层审计楼层明细（按楼层记录修补结果））
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| audit_run_id | bigint unsigned FK | 所属审计运行（thread_floor_audit_runs.id） | 关联字段 |
| audit_thread_id | bigint unsigned FK | 所属审计主题（thread_floor_audit_threads.id） | 关联字段 |
| thread_id | bigint unsigned | 主题（threads.id） | 关联字段 |
| source_thread_id | bigint unsigned | NGA tid | 事实字段 |
| floor_number | int unsigned | 缺失楼层号（0 基） | 状态字段 |
| repair_status | varchar(20) | 修补状态（missing/ignored/repaired/still_missing/failed） | 状态字段 |
| attempt_count_before | smallint unsigned | 修补前尝试次数 | 状态字段 |
| attempt_count_after | smallint unsigned NULL | 修补后尝试次数 | 状态字段 |
| repair_error_category | varchar(20) NULL | 修补失败归因（http/parse/db/unknown） | 状态字段 |
| repair_http_error_code | smallint unsigned NULL | 修补失败的 HTTP 状态码 | 状态字段 |
| repair_error_summary | varchar(200) NULL | 修补失败摘要 | 状态字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

---

### 4.12 `thread_floor_repair_attempts`（表注释：楼层修补尝试次数记录）
| 字段 | 类型 | 含义 | 字段分类 |
|---|---|---|---|
| id | bigint unsigned PK | 内部主键 | 关联字段 |
| thread_id | bigint unsigned | 主题（threads.id） | 关联字段 |
| source_thread_id | bigint unsigned | NGA tid | 事实字段 |
| floor_number | int unsigned | 缺失楼层号（0 基） | 状态字段 |
| attempt_count | tinyint unsigned | 修补尝试次数（单楼层累计） | 状态字段 |
| last_attempted_at | datetime NULL | 最近一次尝试时间 | 状态字段 |
| created_at | datetime | 创建时间 | 状态字段 |
| updated_at | datetime | 更新时间 | 状态字段 |

---

## 6. 扩展点（不污染主表，不用 json/ext）
- **搜索增强**：新增 `thread_search_documents(thread_id, title_text, first_post_plain_text)` 支撑更强检索。
- **媒体本地化**：新增 `media_assets` + `post_media_maps`（需要时再做）。
- **多版块扩展**：继续往 `forums` 加 fid 即可。
