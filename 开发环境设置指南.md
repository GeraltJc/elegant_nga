# 开发环境设置指南（Mac M2 + Docker + Laravel + Vue3）

> 目标：仅用 Docker 容器完成本地开发与联调；宿主机 Mac M2。

## 1. 版本与约束

- Docker Desktop：Version 29.1.3
- Docker Compose：v2.40.3-desktop.1
- 后端：PHP 8.2 + Laravel 12
- 数据库：MySQL 8.0
- 前端：Vue 3
- 时区：`Asia/Shanghai`

## 2. 推荐仓库结构

> 先给出目标结构，后续落地脚手架时按此创建。

```
project-root/
  docker/
    nginx/
      default.conf
    php/
      Dockerfile
      php.ini
    mysql/
      my.cnf
  backend/              # Laravel
  frontend/             # Vue3
  storage/              # 本地持久化（可选）
  logs/
  docker-compose.yml
  .env.example
  README.md
```

## 3. 服务拆分建议

### 3.1 最小可用（MVP）

- nginx：反向代理 + 静态资源 + PHP 转发
- php-fpm：Laravel API + 抓取命令（artisan command）
- mysql：数据存储

### 3.2 可选增强（建议尽早加上，提升稳定性）

- redis：队列/缓存
- queue worker：处理抓取任务（避免 HTTP 请求线程里做抓取）
- scheduler：触发每 12 小时抓取（cron / Laravel scheduler）

> 本项目抓取任务建议走 **队列**：scheduler 只负责投递 job；worker 执行抓取。

## 4. 环境变量（建议）

- `TZ=Asia/Shanghai`
- 后端：
  - `APP_ENV=local`
  - `APP_DEBUG=true`
  - `DB_HOST=mysql`、`DB_PORT=3306`、`DB_DATABASE=...`、`DB_USERNAME=...`、`DB_PASSWORD=...`
- 抓取配置（建议集中在 `config/crawler.php`，后续会生成）：
  - `CRAWLER_FID=7`
  - `CRAWLER_WINDOW_DAYS=3`
  - `CRAWLER_RATE_LIMIT_RPS=1`
  - `CRAWLER_MAX_PAGES_PER_THREAD=5`
  - `CRAWLER_RUN_EVERY_HOURS=12`

## 5. 本地启动与联调流程（不涉及业务代码）

### 5.1 一次性初始化

1) 启动容器
- `docker compose up -d --build`

2) 进入 PHP 容器安装依赖
- `docker compose exec php bash`
- 在容器内执行 `composer install`

3) 生成应用 key、配置环境变量
- `cp .env.example .env`
- `php artisan key:generate`

4) 数据库迁移
- `php artisan migrate`

### 5.2 前端启动

- 在 `frontend/`：`npm i` → `npm run dev`
- 本地开发建议：
  - 前端 dev server 代理到后端 API（nginx 或 vite proxy）

## 6. 定时任务（12 小时一次）

你有两种实现方式：

### 6.1 Laravel Scheduler（推荐）

- 在容器里运行 scheduler：每分钟执行一次 `php artisan schedule:run`
- 由 Scheduler 内部控制“每 12 小时一次”的逻辑

### 6.2 Cron（简单直接）

- 宿主机或 scheduler 容器里配置 cron：每 12 小时触发一次 `php artisan crawler:run`

> 早期建议用 6.1：更容易统一管理、也便于以后上云。

## 7. 开发期调试建议

- 打开抓取日志：
  - 记录请求 URL、状态码、耗时、退避次数
  - 记录解析失败的 tid/pid，便于回放
- 为抓取任务提供“干跑模式”（dry-run）：只拉取与解析、不写库（后续实现）
- 提供“单 tid 抓取命令”：用于复现问题（后续实现）

## 8. TDD 与任务追踪（项目规则）

- TDD 工作流与 DoD：`docs/rules/TDD工作流.md`
- 文件化任务/进度追踪：`docs/rules/文件化进度追踪.md`
- PR 模板：`.github/pull_request_template.md`

## 9. 数据库与字符集

- 建议全库 `utf8mb4`，并统一排序规则（例如 `utf8mb4_0900_ai_ci`）
- 对“标题 + 1 楼正文 LIKE”场景：
  - 需要对 threads.title、threads.first_post_html 建索引意义不大（LIKE 前缀不固定），但可以对 `created_at`/`last_reply_at` 做索引以加速列表与增量扫描

## 10. 常见问题排查（Docker）

- 时区不对：确认容器环境变量 `TZ` 与 MySQL 时区设置
- Nginx 找不到 PHP：检查 fastcgi_pass 的 upstream 名称是否为 `php:9000`
- MySQL 连不上：检查端口映射与容器网络；优先用容器内 host `mysql`
