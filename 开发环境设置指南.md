# 开发环境设置指南（Mac M2 + Docker + Laravel + Vue3）

> 目标：仅用 Docker 容器完成本地开发与联调；宿主机 Mac M2。

## 1. 版本与约束

- Docker Desktop：Version 29.1.3
- Docker Compose：v2.40.3-desktop.1
- 后端：PHP 8.2 + Laravel 12
- 数据库：MySQL 8.0
- 前端：Vue 3
- Node：`20.19`（见 `.nvmrc`）
- 说明：Node 仅用于 `frontend/`；后端（Laravel）不依赖 Node
- 时区：`Asia/Shanghai`

## 2. 推荐仓库结构

> 该结构已在仓库中落地（`docker-compose.yml` + `docker/`），后端/前端代码将由脚手架生成填充。

```
project-root/
  docker/
    nginx/
      default.conf
    frontend/
      Dockerfile
      entrypoint.sh
    php/
      Dockerfile
      php.ini
    mysql/
      my.cnf
  backend/              # Laravel
  frontend/             # Vue3
  storage/              # 本地持久化（可选）
  logs/
  docker-compose.yml
  .env.example
  README.md
```

## 3. 服务拆分建议

### 3.1 最小可用（MVP）

- nginx：反向代理 + 静态资源 + PHP 转发
- php-fpm：Laravel API + 抓取命令（artisan command）
- mysql：数据存储
- frontend：Vite dev server（本地开发）

### 3.2 可选增强（建议尽早加上，提升稳定性）

- redis：队列/缓存
- queue worker：处理抓取任务（避免 HTTP 请求线程里做抓取）
- scheduler：触发每 12 小时抓取（cron / Laravel scheduler）

> 本项目抓取任务建议走 **队列**：scheduler 只负责投递 job；worker 执行抓取。

## 4. 环境变量（建议）

- `TZ=Asia/Shanghai`
- 后端：
  - `APP_ENV=local`
  - `APP_DEBUG=true`
  - `DB_HOST=mysql`、`DB_PORT=3306`、`DB_DATABASE=...`、`DB_USERNAME=...`、`DB_PASSWORD=...`
- 抓取配置（建议集中在 `config/crawler.php`，后续会生成）：
  - `CRAWLER_FID=7`
  - `CRAWLER_WINDOW_DAYS=3`
  - `CRAWLER_RATE_LIMIT_RPS=1`
  - `CRAWLER_MAX_PAGES_PER_THREAD=5`
  - `CRAWLER_RUN_EVERY_HOURS=12`
- 抓取请求（网络与日志）：
  - `NGA_HTTP_CONNECT_TIMEOUT=5`（连接超时，秒）
  - `NGA_HTTP_TIMEOUT=20`（请求总超时，秒）
  - `NGA_HTTP_RETRY_TIMES=3`（重试次数）
  - `NGA_HTTP_RETRY_DELAY_MS=200`（重试间隔，毫秒）
  - `NGA_FORCE_IPV4=1`（强制 IPv4，开启则设为 1/true）
  - `NGA_CURL_LOG_PATH=...`（curl 日志路径，空字符串禁用，默认 `backend/storage/logs/nga-curl.log`）
- HTML 清洗（HTMLPurifier）：
  - `NGA_HTMLPURIFIER_DEFINITION_ID=nga_html`（自定义定义标识）
  - `NGA_HTMLPURIFIER_DEFINITION_REV=1`（定义版本；当调整白名单/自定义属性时需递增以刷新缓存，并执行 `php artisan config:clear` 或 `php artisan config:cache`）
- 前端：
  - `FRONTEND_PORT=5173`（Vite dev server 端口）
  - `VITE_PROXY_TARGET=http://nginx`（Docker 内前端代理到后端）

## 5. 本地启动与联调流程（不涉及业务代码）

### 5.1 一次性初始化

1) 启动容器
- `docker compose up -d --build`

2) 初始化后端代码（Laravel 12，二选一）
- 进入 PHP 容器安装依赖：
  - `docker compose exec php bash`
  - 在容器内执行 `composer install`

3) 生成应用 key、配置环境变量
- `cp .env.example .env`（在 `backend/` 内）
- `php artisan key:generate`

4) 数据库迁移
- `php artisan migrate`

5) 后续更新代码（git pull）后的推荐操作

本项目采用“Docker Compose + bind mount 代码”的方式运行：宿主机 `git pull` 后，容器会立即看到最新代码，但依赖与缓存需要同步。

- 在宿主机执行：`git pull`
- 执行一键后处理脚本（ECS 部署专用）：`bash scripts/deploy-ecs.sh`（依赖 `flock`）

### 5.2 前端启动

- Docker 方式：
  - `docker compose up -d frontend`
  - 访问 `http://localhost:5173`（可用 `FRONTEND_PORT` 调整）
- 若接口走代理：容器内默认指向 `http://nginx`
- 本地开发建议：前端 dev server 代理到后端 API（nginx 或 vite proxy）

### 5.3 前端测试（Vitest）

- 在 `frontend/`：`npm test`

## 6. 定时任务（12 小时一次）

你有两种实现方式：

### 6.1 Laravel Scheduler（推荐）

- 在容器里运行 scheduler：每分钟执行一次 `php artisan schedule:run`
- 由 Scheduler 内部控制“每 12 小时一次”的逻辑

### 6.2 Cron（简单直接）

- 宿主机或 scheduler 容器里配置 cron：每 12 小时触发一次 `php artisan crawler:run`

> 早期建议用 6.1：更容易统一管理、也便于以后上云。

## 7. 开发期调试建议

- 打开抓取日志：
  - 记录请求 URL、状态码、耗时、退避次数
  - 记录解析失败的 tid/pid，便于回放
- 如需回放请求，可查看 `backend/storage/logs/nga-curl.log`（可用 `NGA_CURL_LOG_PATH` 覆盖或置空禁用）
- 为抓取任务提供“干跑模式”（dry-run）：只拉取与解析、不写库（后续实现）
- 提供“单 tid 抓取命令”：用于复现问题（后续实现）

## 8. TDD 与任务追踪（项目规则）

- TDD 工作流与 DoD：`docs/rules/TDD工作流.md`
- 文件化任务/进度追踪：`docs/rules/文件化进度追踪.md`
- PR 模板：`.github/pull_request_template.md`

## 9. CI（GitHub Actions）

- 工作流：`.github/workflows/ci.yml`
- 后端：`composer install` → `php artisan migrate` → `php artisan test`（SQLite）
- 前端：`npm ci` → `npm test` → `npm run build`

## 10. 数据库与字符集

- 建议全库 `utf8mb4`，并统一排序规则（例如 `utf8mb4_0900_ai_ci`）
- 对“标题 + 1 楼正文 LIKE”场景：
  - 需要对 threads.title、threads.first_post_html 建索引意义不大（LIKE 前缀不固定），但可以对 `created_at`/`last_reply_at` 做索引以加速列表与增量扫描

## 11. 常见问题排查（Docker）

- 时区不对：确认容器环境变量 `TZ` 与 MySQL 时区设置
- Nginx 找不到 PHP：检查 fastcgi_pass 的 upstream 名称是否为 `php:9000`
- MySQL 连不上：检查端口映射与容器网络；优先用容器内 host `mysql`
